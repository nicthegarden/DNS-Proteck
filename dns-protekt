#!/bin/bash
#
# DNS-Protekt for Linux
# Enhanced version with logging, error handling, and multiple blocklist sources
# Blocks malicious domains by updating /etc/hosts
#

set -euo pipefail

# Configuration
SCRIPT_DIR="/opt/dns-protekt"
CONFIG_FILE="$SCRIPT_DIR/dns-protekt.conf"
LOG_FILE="/var/log/dns-protekt.log"
BACKUP_DIR="$SCRIPT_DIR/backups"
TEMP_DIR="$SCRIPT_DIR/temp"
LOCK_FILE="/var/run/dns-protekt.lock"

# Default settings
DEFAULT_BLOCKLIST_URL="https://someonewhocares.org/hosts/hosts"
DEFAULT_UPDATE_INTERVAL="daily"
DEFAULT_BACKUP_RETENTION=7

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Logging function
log() {
    local level="$1"
    shift
    local message="$*"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] [$level] $message" >> "$LOG_FILE"
    
    # Also output to console if running interactively
    if [[ -t 1 ]]; then
        case "$level" in
            ERROR) echo -e "${RED}[$level]${NC} $message" >&2 ;;
            WARN)  echo -e "${YELLOW}[$level]${NC} $message" ;;
            INFO)  echo -e "${GREEN}[$level]${NC} $message" ;;
            *)     echo "[$level] $message" ;;
        esac
    fi
}

# Check if running as root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        log "ERROR" "This script must be run as root"
        exit 1
    fi
}

# Create lock file to prevent concurrent runs
create_lock() {
    if [[ -f "$LOCK_FILE" ]]; then
        local pid=$(cat "$LOCK_FILE" 2>/dev/null || echo "")
        if [[ -n "$pid" ]] && kill -0 "$pid" 2>/dev/null; then
            log "WARN" "Another instance is already running (PID: $pid)"
            exit 1
        fi
    fi
    echo $$ > "$LOCK_FILE"
}

# Remove lock file
remove_lock() {
    rm -f "$LOCK_FILE"
}

# Load configuration
load_config() {
    if [[ -f "$CONFIG_FILE" ]]; then
        source "$CONFIG_FILE"
        log "INFO" "Configuration loaded from $CONFIG_FILE"
    else
        log "WARN" "No configuration file found, using defaults"
        BLOCKLIST_URL="$DEFAULT_BLOCKLIST_URL"
        UPDATE_INTERVAL="$DEFAULT_UPDATE_INTERVAL"
        BACKUP_RETENTION="$DEFAULT_BACKUP_RETENTION"
    fi
}

# Create necessary directories
create_directories() {
    mkdir -p "$SCRIPT_DIR" "$BACKUP_DIR" "$TEMP_DIR"
    chmod 755 "$SCRIPT_DIR"
    log "INFO" "Directories created/verified"
}

# Backup original hosts file
backup_hosts() {
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_file="$BACKUP_DIR/hosts.backup.$timestamp"
    
    if [[ -f /etc/hosts ]]; then
        cp /etc/hosts "$backup_file"
        chmod 644 "$backup_file"
        log "INFO" "Hosts file backed up to $backup_file"
        
        # Clean old backups
        clean_old_backups
    else
        log "ERROR" "Original /etc/hosts not found!"
        exit 1
    fi
}

# Clean old backups (keep only last N)
clean_old_backups() {
    local count=$(find "$BACKUP_DIR" -name "hosts.backup.*" -type f | wc -l)
    if [[ $count -gt $BACKUP_RETENTION ]]; then
        find "$BACKUP_DIR" -name "hosts.backup.*" -type f -printf '%T+ %p\n' | \
            sort | head -n -$BACKUP_RETENTION | cut -d' ' -f2 | xargs -r rm
        log "INFO" "Cleaned old backups, keeping last $BACKUP_RETENTION"
    fi
}

# Download blocklist with retry logic
download_blocklist() {
    local temp_file="$TEMP_DIR/newhosts.tmp"
    local max_retries=3
    local retry=0
    
    log "INFO" "Downloading blocklist from $BLOCKLIST_URL"
    
    while [[ $retry -lt $max_retries ]]; do
        if curl -fsSL --max-time 30 -o "$temp_file" "$BLOCKLIST_URL" 2>/dev/null; then
            log "INFO" "Blocklist downloaded successfully"
            
            # Validate downloaded file
            if [[ -s "$temp_file" ]] && grep -q "127.0.0.1" "$temp_file"; then
                return 0
            else
                log "ERROR" "Downloaded file is empty or invalid"
                return 1
            fi
        fi
        
        retry=$((retry + 1))
        log "WARN" "Download attempt $retry failed, retrying..."
        sleep 5
    done
    
    log "ERROR" "Failed to download blocklist after $max_retries attempts"
    return 1
}

# Restore original hosts from backup
restore_original_hosts() {
    # Find the oldest backup (which should be the original)
    local original_backup=$(find "$BACKUP_DIR" -name "hosts.backup.*" -type f -printf '%T+ %p\n' | sort | head -1 | cut -d' ' -f2)
    
    if [[ -n "$original_backup" ]] && [[ -f "$original_backup" ]]; then
        cp "$original_backup" /etc/hosts
        chmod 644 /etc/hosts
        log "INFO" "Restored original hosts from $original_backup"
    else
        # Create minimal hosts file
        cat > /etc/hosts << 'EOF'
127.0.0.1       localhost
127.0.1.1       localhost
::1             localhost ip6-localhost ip6-loopback
ff02::1         ip6-allnodes
ff02::2         ip6-allrouters
EOF
        chmod 644 /etc/hosts
        log "WARN" "Created minimal hosts file (no backup found)"
    fi
}

# Update hosts file with new blocklist
update_hosts() {
    local temp_file="$TEMP_DIR/newhosts.tmp"
    local marker="# --- DNS-Protekt Blocklist Start ---"
    local marker_end="# --- DNS-Protekt Blocklist End ---"
    
    log "INFO" "Updating hosts file..."
    
    # First, restore original hosts (without old blocklist)
    restore_original_hosts
    
    # Clean and prepare blocklist entries
    local cleaned_blocklist="$TEMP_DIR/cleaned_blocklist.tmp"
    
    # Extract only valid host entries (lines with 127.0.0.1 or 0.0.0.0 followed by domain)
    grep -E '^\s*(127\.0\.0\.1|0\.0\.0\.0)\s+[a-zA-Z0-9.-]+' "$temp_file" | \
        sed 's/^[[:space:]]*//' | \
        awk '{print $1 "\t" $2}' | \
        sort -u > "$cleaned_blocklist"
    
    # Count blocked domains
    local blocked_count=$(wc -l < "$cleaned_blocklist")
    log "INFO" "Processing $blocked_count domains to block"
    
    # Append blocklist to hosts with markers
    {
        echo ""
        echo "$marker"
        echo "# Updated: $(date)"
        echo "# Source: $BLOCKLIST_URL"
        echo "# Total blocked domains: $blocked_count"
        echo "#"
        cat "$cleaned_blocklist"
        echo "$marker_end"
    } >> /etc/hosts
    
    chmod 644 /etc/hosts
    log "INFO" "Hosts file updated successfully with $blocked_count blocked domains"
}

# Verify DNS resolution is working
verify_dns() {
    log "INFO" "Verifying DNS functionality..."
    
    # Test if we can still resolve legitimate domains
    if ! getent hosts google.com >/dev/null 2>&1; then
        log "ERROR" "DNS resolution test failed! Restoring original hosts..."
        restore_original_hosts
        return 1
    fi
    
    # Test if blocked domains are actually blocked
    local test_blocked=$(grep -m1 "127.0.0.1" /etc/hosts | awk '{print $2}' | head -1)
    if [[ -n "$test_blocked" ]]; then
        if getent hosts "$test_blocked" 2>/dev/null | grep -q "127.0.0.1"; then
            log "INFO" "Verification passed: $test_blocked is correctly blocked"
        fi
    fi
    
    log "INFO" "DNS verification completed successfully"
    return 0
}

# Display statistics
show_stats() {
    local blocked_count=$(grep -c "127.0.0.1\|0.0.0.0" /etc/hosts 2>/dev/null || echo "0")
    local backup_count=$(find "$BACKUP_DIR" -name "hosts.backup.*" 2>/dev/null | wc -l)
    local last_update=$(grep "# Updated:" /etc/hosts 2>/dev/null | head -1 | sed 's/# Updated: //')
    
    echo ""
    echo "=== DNS-Protekt Statistics ==="
    echo "Blocked domains: $blocked_count"
    echo "Available backups: $backup_count"
    echo "Last update: ${last_update:-Never}"
    echo "Config file: $CONFIG_FILE"
    echo "Log file: $LOG_FILE"
    echo "=============================="
}

# Uninstall function
uninstall() {
    log "INFO" "Uninstalling DNS-Protekt..."
    
    # Stop and disable service
    systemctl stop dns-protekt 2>/dev/null || true
    systemctl disable dns-protekt 2>/dev/null || true
    
    # Restore original hosts
    restore_original_hosts
    
    # Remove files
    rm -rf "$SCRIPT_DIR"
    rm -f /etc/systemd/system/dns-protekt.service
    rm -f /usr/local/bin/dns-protekt
    rm -f "$LOCK_FILE"
    
    systemctl daemon-reload
    
    log "INFO" "DNS-Protekt uninstalled successfully"
    echo "DNS-Protekt has been uninstalled and hosts file restored."
}

# Main execution
main() {
    local command="${1:-run}"
    
    case "$command" in
        run|update)
            check_root
            create_lock
            trap remove_lock EXIT
            load_config
            create_directories
            backup_hosts
            if download_blocklist; then
                update_hosts
                verify_dns
                show_stats
            else
                log "ERROR" "Update failed, keeping existing hosts file"
                exit 1
            fi
            ;;
        restore)
            check_root
            load_config
            restore_original_hosts
            log "INFO" "Original hosts file restored"
            ;;
        stats)
            load_config
            show_stats
            ;;
        uninstall)
            check_root
            uninstall
            ;;
        *)
            echo "Usage: $0 {run|update|restore|stats|uninstall}"
            echo ""
            echo "Commands:"
            echo "  run|update  - Download and apply blocklist (default)"
            echo "  restore     - Restore original hosts file"
            echo "  stats       - Show current statistics"
            echo "  uninstall   - Remove DNS-Protekt and restore hosts"
            exit 1
            ;;
    esac
}

# Run main function
main "$@"
